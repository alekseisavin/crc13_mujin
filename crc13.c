/**
 * @file    crc13.c
 * @brief   CRC13 implementation
 * @requirements
 *      Length: 13
 *      Polynomial: 0x1909
 *      Initial value: 0
 *      No XOR in/out
 *      Not reflected
 */

#include <stdio.h>
#include <stdint.h>

#include "crc13.h"

#define CRC13_POLYNOMIAL        (0x1909)
#define CRC13_MASK              (0x1FFF)
#define CRC13_LENGTH            (13u)

static const uint16_t crc13_lut[256u] = 
{
    0x0000, 0x1909, 0x0B1B, 0x1212, 0x1636, 0x0F3F, 0x1D2D, 0x0424, 
    0x1565, 0x0C6C, 0x1E7E, 0x0777, 0x0353, 0x1A5A, 0x0848, 0x1141, 
    0x13C3, 0x0ACA, 0x18D8, 0x01D1, 0x05F5, 0x1CFC, 0x0EEE, 0x17E7, 
    0x06A6, 0x1FAF, 0x0DBD, 0x14B4, 0x1090, 0x0999, 0x1B8B, 0x0282, 
    0x1E8F, 0x0786, 0x1594, 0x0C9D, 0x08B9, 0x11B0, 0x03A2, 0x1AAB, 
    0x0BEA, 0x12E3, 0x00F1, 0x19F8, 0x1DDC, 0x04D5, 0x16C7, 0x0FCE, 
    0x0D4C, 0x1445, 0x0657, 0x1F5E, 0x1B7A, 0x0273, 0x1061, 0x0968, 
    0x1829, 0x0120, 0x1332, 0x0A3B, 0x0E1F, 0x1716, 0x0504, 0x1C0D, 
    0x0417, 0x1D1E, 0x0F0C, 0x1605, 0x1221, 0x0B28, 0x193A, 0x0033, 
    0x1172, 0x087B, 0x1A69, 0x0360, 0x0744, 0x1E4D, 0x0C5F, 0x1556, 
    0x17D4, 0x0EDD, 0x1CCF, 0x05C6, 0x01E2, 0x18EB, 0x0AF9, 0x13F0, 
    0x02B1, 0x1BB8, 0x09AA, 0x10A3, 0x1487, 0x0D8E, 0x1F9C, 0x0695, 
    0x1A98, 0x0391, 0x1183, 0x088A, 0x0CAE, 0x15A7, 0x07B5, 0x1EBC, 
    0x0FFD, 0x16F4, 0x04E6, 0x1DEF, 0x19CB, 0x00C2, 0x12D0, 0x0BD9, 
    0x095B, 0x1052, 0x0240, 0x1B49, 0x1F6D, 0x0664, 0x1476, 0x0D7F, 
    0x1C3E, 0x0537, 0x1725, 0x0E2C, 0x0A08, 0x1301, 0x0113, 0x181A, 
    0x082E, 0x1127, 0x0335, 0x1A3C, 0x1E18, 0x0711, 0x1503, 0x0C0A, 
    0x1D4B, 0x0442, 0x1650, 0x0F59, 0x0B7D, 0x1274, 0x0066, 0x196F, 
    0x1BED, 0x02E4, 0x10F6, 0x09FF, 0x0DDB, 0x14D2, 0x06C0, 0x1FC9, 
    0x0E88, 0x1781, 0x0593, 0x1C9A, 0x18BE, 0x01B7, 0x13A5, 0x0AAC, 
    0x16A1, 0x0FA8, 0x1DBA, 0x04B3, 0x0097, 0x199E, 0x0B8C, 0x1285, 
    0x03C4, 0x1ACD, 0x08DF, 0x11D6, 0x15F2, 0x0CFB, 0x1EE9, 0x07E0, 
    0x0562, 0x1C6B, 0x0E79, 0x1770, 0x1354, 0x0A5D, 0x184F, 0x0146, 
    0x1007, 0x090E, 0x1B1C, 0x0215, 0x0631, 0x1F38, 0x0D2A, 0x1423, 
    0x0C39, 0x1530, 0x0722, 0x1E2B, 0x1A0F, 0x0306, 0x1114, 0x081D, 
    0x195C, 0x0055, 0x1247, 0x0B4E, 0x0F6A, 0x1663, 0x0471, 0x1D78, 
    0x1FFA, 0x06F3, 0x14E1, 0x0DE8, 0x09CC, 0x10C5, 0x02D7, 0x1BDE, 
    0x0A9F, 0x1396, 0x0184, 0x188D, 0x1CA9, 0x05A0, 0x17B2, 0x0EBB, 
    0x12B6, 0x0BBF, 0x19AD, 0x00A4, 0x0480, 0x1D89, 0x0F9B, 0x1692, 
    0x07D3, 0x1EDA, 0x0CC8, 0x15C1, 0x11E5, 0x08EC, 0x1AFE, 0x03F7, 
    0x0175, 0x187C, 0x0A6E, 0x1367, 0x1743, 0x0E4A, 0x1C58, 0x0551, 
    0x1410, 0x0D19, 0x1F0B, 0x0602, 0x0226, 0x1B2F, 0x093D, 0x1034, 
};

// Equation used to generate the lookup table
/*
void crc13_table_init(void)
{
    for (uint16_t i = 0; i < 256u; i++)
    {
        uint16_t crc = i << (CRC13_LENGTH - 8u);

        for (uint16_t j = 0u; j < 8u; j++)
        {
            if (crc & (1 << (CRC13_LENGTH - 1))) 
            {
                crc = (crc << 1) ^ (CRC13_POLYNOMIAL);
            }
            else
            {
                crc <<= 1;
            }
        }

        crc13_lut[i] = crc & CRC13_MASK;

    }
}
*/

/**
 * @brief   CRC13 implementation
 * @param   data:     Input data from STDIN
 * @param   length:   Length of CRC
 * @return  Calculated CRC
 */
uint16_t crc13(char* data, size_t length, uint16_t crc)
{
    for (uint16_t i = 0; i < length; i++)
    {
        uint8_t index = (crc >> (CRC13_LENGTH - 8u)) ^ data[i];
        crc = (crc << 8u) ^ crc13_lut[index];
    }

    return crc & CRC13_MASK;
}

